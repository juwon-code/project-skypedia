# ë¦´ë¦¬ìŠ¤ ë¸Œëœì¹˜ì—ì„œ CI ë° CDë¥¼ ìˆ˜í–‰í•˜ëŠ” ì›Œí¬í”Œë¡œ ì…ë‹ˆë‹¤.
# release ë¸Œëœì¹˜ì— Push ë° PRì—ì„œ ìë™ìœ¼ë¡œ ì‹¤í–‰ë˜ë©°, í•„ìš”í•  ê²½ìš° ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

name: CI-CD

on:
  pull_request:
    branches: [ "release" ]
  workflow_dispatch:

env:
  DOCKER_IMAGE_PATH: ${{ secrets.DOCKER_USERNAME }}/${{ secrets.APPLICATION_NAME }}:latest

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
      - name: Checkout Repository
        uses: actions/checkout@v4.2.2

      # ë°°í¬ìš© ì„¤ì •íŒŒì¼ ìƒì„±
      - name: Create properties from secrets
        run: | 
          echo "${{ secrets.PRODUCE_PROPERTIES }}" | base64 --decode > ./src/main/resources/application-prod.properties

      # JDK 17 ì„¤ì¹˜
      - name: Setup Java Development Kit 17
        uses: actions/setup-java@v4.6.0
        with:
          java-version: '17'
          distribution: 'temurin'

      # ë¹Œë“œ ì‹¤í–‰ ê¶Œí•œ ì·¨ë“
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # í”„ë¡œì íŠ¸ ë¹Œë“œ
      - name: Build with gradle
        run: ./gradlew clean build

      # ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ
      - name: Build Docker image
        run: docker build -t ${{ env.DOCKER_IMAGE_PATH }}

      # ë„ì»¤ í—ˆë¸Œ ë¡œê·¸ì¸
      - name: Sign-in to DockerHub
        uses: docker/login-action@v3.3.0
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # ë„ì»¤ ì´ë¯¸ì§€ ì „ë‹¬í•˜ê¸°
      - name: Push Docker image
        run: docker push ${{ env.DOCKER_IMAGE_PATH }}

  deploy:
    needs: build
    runs-on: self-hosted
    steps:
      # ë„ì»¤ í—ˆë¸Œ ë¡œê·¸ì¸
      - name: Sign-in to DockerHub
        uses: docker/login-action@v3.3.0
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # ë„ì»¤ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
      - name: Pull Docker image
        run: sudo docker pull ${{ secrets.APPLICATION_NAME }}

      # ë ˆë””ìŠ¤ ì»¨í…Œì´ë„ˆ ìµœì‹ í™”
      - name: Start Redis container
        run: |
          sudo docker stop redis_container || true
          sudo docker rm redis_container || true
          sudo docker run -d --name redis_container -p 6379:6379 redis:latest

      # í”„ë¡œì íŠ¸ ì»¨í…Œì´ë„ˆ ìµœì‹ í™”
      - name: Start Project container
        run: |
          sudo docker stop ${{ secrets.APPLICATION_NAME }} || true
          sudo docker rm ${{ secrets.APPLICATION_NAME }} || true
          sudo docker run -d --name ${{ secrets.APPLICATION_NAME }} -p 8080:8080 ${{ env.DOCKER_IMAGE_PATH }}

      # ë„ì»¤ ì´ë¯¸ì§€ ì‚­ì œ
      - name: Remove old Docker image
        run: sudo docker image prune -a -f || true

  notification:
    needs: [ build, deploy ]
    runs-on: ubuntu-latest
    steps:
      # í˜„ì¬ ì‹œê°„ ì–»ê¸°
      - name: Get current time
        uses: josStorer/get-current-time@v2.1.2
        id: current-datetime
        with:
          format: YYYY-MM-DDTHH:mm:ss
          utcOffset: "+09:00"

      # ìŠ¬ë™ ë©”ì‹œì§€ ì „ì†¡ (ì„±ê³µ)
      - name: Send Slack Message on Success
        if: success()
        uses: 8398a7/action-slack@v3.16.2
        with:
          status: success
          text: |
            âœ… *ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ì„±ê³µ*
            ì„œë²„ì— ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ë¥¼ ì„±ê³µì ìœ¼ë¡œ ìˆ˜í–‰í–ˆìŠµë‹ˆë‹¤.
            ì‘ì—… ì¼ì‹œ: ${{ steps.current-datetime.outputs.formattedTime }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      # ìŠ¬ë™ ë©”ì‹œì§€ ì „ì†¡ (ì‹¤íŒ¨)
      - name: Send Slack Message on Failure
        if: failure()
        uses: 8398a7/action-slack@v3.16.2
        with:
          status: failure
          text: |
            ğŸš¨ *ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ì‹¤íŒ¨*
            ì„œë²„ì— ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë°°í¬ ì‘ì—…ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.
            ê°œë°œìë‹˜ê»˜ì„œëŠ” ì›ì¸ì„ íŒŒì•…í•˜ì—¬ ì ì ˆí•œ ì¡°ì¹˜ë¥¼ ì·¨í•´ì£¼ì„¸ìš”.
            ì‘ì—… ì¼ì‹œ: ${{ steps.current-datetime.outputs.formattedTime }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}