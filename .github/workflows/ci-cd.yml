# ë¦´ë¦¬ìŠ¤ ë¸Œëœì¹˜ì—ì„œ CI ë° CDë¥¼ ìˆ˜í–‰í•˜ëŠ” ì›Œí¬í”Œë¡œ ì…ë‹ˆë‹¤.
# release ë¸Œëœì¹˜ì— Push ë° PRì—ì„œ ìë™ìœ¼ë¡œ ì‹¤í–‰ë˜ë©°, í•„ìš”í•  ê²½ìš° ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

name: CI-CD

on:
  pull_request:
    branches: [ "release" ]
  workflow_dispatch:

env:
  DOCKER_IMAGE_PATH: ${{ secrets.DOCKER_USERNAME }}/${{ secrets.APPLICATION_NAME }}:latest

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
      - name: Checkout Repository
        uses: actions/checkout@v4.2.2

      # ë°°í¬ìš© í™˜ê²½ë³€ìˆ˜íŒŒì¼ ìƒì„±
      - name: Create properties from secrets
        run: | 
          echo "${{ secrets.PRODUCE_ENV }}" | base64 --decode > .env

      # JDK 17 ì„¤ì¹˜
      - name: Setup Java Development Kit 17
        uses: actions/setup-java@v4.6.0
        with:
          java-version: '17'
          distribution: 'temurin'

      # ë¹Œë“œ ì‹¤í–‰ ê¶Œí•œ ì·¨ë“
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # í”„ë¡œì íŠ¸ ë¹Œë“œ
      - name: Build with gradle
        run: ./gradlew clean build

      # ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ
      - name: Build Docker image
        run: docker build -t ${{ env.DOCKER_IMAGE_PATH }}

      # ë„ì»¤ í—ˆë¸Œ ë¡œê·¸ì¸
      - name: Sign-in to DockerHub
        uses: docker/login-action@v3.3.0
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # ë„ì»¤ ì´ë¯¸ì§€ ì „ë‹¬í•˜ê¸°
      - name: Push Docker image
        run: docker push ${{ env.DOCKER_IMAGE_PATH }}

  deploy:
    needs: build
    runs-on: self-hosted
    steps:
      # SSH ì ‘ì† ë° ë°°í¬
      - name: SSH to deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.GCP_HOST }}
          username: ${{ secrets.GCP_USERNAME }}
          key: ${{ secrets.GCP_KEY }}
          port: ${{ secrets.GCP_SSH_PORT }}
          script: |
            sudo docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
            sudo docker rm -f $(sudo docker ps -qa)
            sudo docker pull ${{ env.DOCKER_IMAGE_PATH }}
            sudo docker-compose up -d
            sudo docker image prune -f

  notification:
    needs: [ build, deploy ]
    runs-on: ubuntu-latest
    steps:
      # í˜„ì¬ ì‹œê°„ ì–»ê¸°
      - name: Get current time
        uses: josStorer/get-current-time@v2.1.2
        id: current-datetime
        with:
          format: YYYY-MM-DDTHH:mm:ss
          utcOffset: "+09:00"

      # ìŠ¬ë™ ë©”ì‹œì§€ ì „ì†¡ (ì„±ê³µ)
      - name: Send Slack Message on Success
        if: success()
        uses: 8398a7/action-slack@v3.16.2
        with:
          status: success
          text: |
            âœ… *ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ì„±ê³µ*
            ì„œë²„ì— ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ë¥¼ ì„±ê³µì ìœ¼ë¡œ ìˆ˜í–‰í–ˆìŠµë‹ˆë‹¤.
            ì‘ì—… ì¼ì‹œ: ${{ steps.current-datetime.outputs.formattedTime }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      # ìŠ¬ë™ ë©”ì‹œì§€ ì „ì†¡ (ì‹¤íŒ¨)
      - name: Send Slack Message on Failure
        if: failure()
        uses: 8398a7/action-slack@v3.16.2
        with:
          status: failure
          text: |
            ğŸš¨ *ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ì‹¤íŒ¨*
            ì„œë²„ì— ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ë°°í¬ ì‘ì—…ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.
            ê°œë°œìë‹˜ê»˜ì„œëŠ” ì›ì¸ì„ íŒŒì•…í•˜ì—¬ ì ì ˆí•œ ì¡°ì¹˜ë¥¼ ì·¨í•´ì£¼ì„¸ìš”.
            ì‘ì—… ì¼ì‹œ: ${{ steps.current-datetime.outputs.formattedTime }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}