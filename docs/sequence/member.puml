@startuml
title 회원 API 시퀀스 다이어그램

actor Client as client

participant "DispatcherServlet" as dispatcher_servlet #LightBlue
participant "MemberController" as member_controller #LightGreen
participant "MemberService" as member_service #LightGreen
participant "PhotoMemberService" as photo_member_service #LightGreen
participant "SecurityUtil" as security_util #LightGreen
participant "SecurityContextHolder" as security_context_holder #LightBlue
participant "MemberQueryRepository" as member_query_repository #LightGreen
participant "GlobalExceptionHandler" as global_exception_handler #LightCoral
database "Database" as db

group 내 프로필 조회
    client -> dispatcher_servlet: "GET /api/v1/member" 요청
    activate client
    activate dispatcher_servlet

    dispatcher_servlet -> member_controller: readMe() 메소드 실행
    activate member_controller

    member_controller -> member_service: getMyProfile() 메소드 호출
    activate member_service

    member_service -> security_util: getCurrentMemberId() 메소드 호출
    activate security_util

    security_util -> security_context_holder: getContext() 메소드 호출

    note right security_util: getContext()를 호출하여 SeucirtyContext의 Authentication 객체를 가져옵니다.

    alt Valid Authentication object
        security_context_holder --> security_util: Authentication 객체 반환
        deactivate security_context_holder

        security_util --> member_service: 회원 ID 반환
        deactivate security_util

        note right member_service: 회원 ID는 Authentication 객체의 Principal과 일치합니다.

        member_service -> member_query_repository: findOneBy(searchOption) 메소드 호출

        note right member_service: 회원 ID를 검색옵션으로 사용하여 데이터를 조회합니다.

        activate member_query_repository
        member_query_repository --> member_service: Member 객체 반환
        deactivate member_query_repository

        alt 유효한 회원 데이터
            member_service -> photo_member_service: getReadUrl(memberId) 메소드 호출
            note right member_service: getReadUrl(memberId)를 호출하여 프로필 사진 URL을 가져옵니다.

            activate photo_member_service
            photo_member_service -> db: Search profile photo data
            note right photo_member_service: 자세한 사항은, 사진 API 시퀀스 다이어그램을 참고해주세요.
            db --> photo_member_service: Photo 객체 반환
            photo_member_service --> member_service: 프로필 사진 URL 반환
            deactivate photo_member_service

            member_service --> member_controller: Profile 객체 반환
            note right member_controller: 회원 정보와 프로필 사진 링크를 합친 DTO를 반환합니다.
            deactivate member_service

            member_controller --> dispatcher_servlet: ResponseEntity<MemberProfile> 객체 반환
            note right dispatcher_servlet: 프로필과 성공 메시지를 ResponseEntity로 감싸서 반환합니다.
            dispatcher_servlet --> client: 200 OK 응답
        else 회원 데이터 없음
            member_service -> global_exception_handler: MemberNotFoundException 예외 발생
            activate global_exception_handler
            global_exception_handler --> client: 404 Not Found 응답
            note right client: 에러 메시지: 해당 회원이 존재하지 않습니다.
            deactivate global_exception_handler
        else 탈퇴 중인 회원
            member_service -> global_exception_handler: WithdrawnMemberException 예외 발생
            activate global_exception_handler
            global_exception_handler --> client: 400 Bad Request 응답
            note right client: 에러 메시지: 탈퇴한 회원은 이용할 수 없는 서비스입니다.
            deactivate global_exception_handler
        end

    else Invalid Authentication Object (NULL | UnAuthenticated)
        security_context_holder --> security_util: null 반환
        deactivate security_context_holder
        security_util -> global_exception_handler: throw NotAuthenticatedException
        activate global_exception_handler
        global_exception_handler --> client: 401 Unauthorized (로그인이 필요합니다.)
        deactivate global_exception_handler

        deactivate client
        deactivate member_controller
        deactivate dispatcher_servlet
    end
end
@enduml