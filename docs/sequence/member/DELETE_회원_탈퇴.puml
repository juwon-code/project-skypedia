@startuml
autonumber

title 회원 탈퇴 API 시퀀스 다이어그램

actor User as user

box "Presentation Layer"
    participant "DispatcherServlet" as dispatcher_servlet
    participant "MemberController" as member_controller
end box

box "Service Layer" #Pink
    participant "MemberService" as member_service
    participant "JwtTokenService" as jwt_token_service
end box

box "Utility Layer" #LightYellow
    participant "SecurityUtil" as security_util
end box

box "Repository Layer" #LightGreen
    participant "MemberQueryRepository" as member_query_repository
    participant "MemberDocumentRepository" as member_document_repository
end box

box "Infrastructure Layer" #LightBlue
    participant "GlobalExceptionHandler" as global_exception_handler
    database "Database" as db
    database "Redis" as rs
    database "ElasticSearch" as es
end box

group 회원 탈퇴
    user -> dispatcher_servlet: "DELETE /api/v1/member" 요청
    activate user
    dispatcher_servlet -> member_controller: withdrawMe() 메소드 실행
    activate member_controller
    member_controller -> member_service: removeMe() 메소드 호출
    activate member_service

    member_service -> security_util: getCurrentMemberId() 메소드 호출
    note right member_service: 현재 로그인한 회원의 ID를 가져오는 메소드입니다.
    activate security_util

    alt 유효하지 않은 Authentication 객체
        security_util -> global_exception_handler: NotAuthenticatedException 예외 발생
        global_exception_handler --> user: 401 Unauthorized 응답
        note right user: 에러 메시지: 해당 서비스를 사용하기 위해서는 로그인이 필요합니다.
    else 유효한 Authentication 객체
        security_util --> member_service: 회원 ID 반환
        deactivate security_util
        note right member_service: 회원 ID는 Authentication 객체의 Principal과 일치합니다.

        member_service -> member_query_repository: findOneBy(searchOption) 메소드 호출
        note right member_service: 회원 ID를 검색옵션으로 사용하여 데이터를 조회합니다.
        activate member_query_repository
        member_query_repository -> db: ID와 일치하는 회원 데이터 조회
        db --> member_query_repository: 조회한 회원 데이터 반환
        member_query_repository --> member_service: Member 객체 반환
        deactivate member_query_repository
        alt 유효하지 않은 회원 데이터
            member_service -> global_exception_handler: MemberNotFoundException 예외 발생
            global_exception_handler --> user: 404 Not Found 응답
            note right user: 에러 메시지: 해당 회원이 존재하지 않습니다.
        else 유효한 회원 데이터
            alt 탈퇴한 회원
                member_service -> global_exception_handler: AlreadyWithdrawnException 예외 발생
                global_exception_handler --> user: 400 Bad Request 응답
                note right user: 에러 메시지: 이미 탈퇴한 회원입니다.
            else 탈퇴하지 않은 회원
                member_service -> member_service: 탈퇴 여부, 삭제 일시 설정
                member_service -> member_document_repository: get(memberId) 메소드 호출
                activate member_document_repository

                member_document_repository -> es: 회원 ID와 일치하는 문서 데이터 검색
                es --> member_document_repository: 회원 ID와 일치하는 문서 데이터 반환
                member_document_repository --> member_service: MemberDocument 객체 반환
                deactivate member_document_repository

                member_service -> member_document_repository: save(MemberDocument) 메소드 호출
                activate member_document_repository
                member_document_repository -> es: 변경할 삭제일시를 문서에 반영
                deactivate member_document_repository

                member_service -> jwt_token_service: deleteRefreshToken(memberId) 메소드 호출
                activate jwt_token_service
                jwt_token_service -> rs: 회원 ID와 연관된 리프레시 토큰 삭제
                deactivate jwt_token_service

                member_service --> member_controller: Remove DTO 객체 반환
                note right of member_controller
                    탈퇴 일시, 영구 삭제 일시를 포함한 데이터를 반환합니다.
                    ※ Dirty Checking으로 DB에 값이 자동으로 반영됩니다.
                end note
                deactivate member_service

                member_controller --> dispatcher_servlet: ResponseEntity<CommonResponse> 객체 반환
                note right dispatcher_servlet: 성공 메시지와 데이터를 ResponseEntity로 감싸서 반환합니다.
                deactivate member_controller

                dispatcher_servlet --> user: 200 OK 응답
                note right user: 성공 메시지: 회원이 탈퇴되었습니다.
                deactivate user
            end
        end
    end
end
@enduml