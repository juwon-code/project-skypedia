@startuml
autonumber

title 관리자 권한 부여 API 시퀀스 다이어그램

actor Admin as admin

box "Presentation Layer"
    participant "DispatcherServlet" as dispatcher_servlet
    participant "AdminMemberController" as admin_member_controller
end box

box "Service Layer" #Pink
    participant "MemberService" as member_service
    participant "MemberRoleService" as member_role_service
end box

box "Repository Layer" #LightGreen
    participant "MemberQueryRepository" as member_query_repository
    participant "MemberRoleQueryRepository" as member_role_query_repository
    participant "MemberDocumentRepository" as member_document_repository
end box

box "Infrastructure Layer" #LightBlue
    participant "GlobalExceptionHandler" as global_exception_handler
    database "Database" as db
    database "Redis" as rs
    database "Elasticsearch" as es
end box

group 관리자 권한 부여
    admin -> dispatcher_servlet: "PATCH /api/v1/admin/member/role/{memberId}" 요청
    activate admin

    dispatcher_servlet -> admin_member_controller: grantAdminRole(memberId) 메소드 실행
    activate admin_member_controller

    alt PathVariable 검증 실패 (음수값 감지)
        admin_member_controller -> global_exception_handler: ConstraintViolationException 예외 발생
        global_exception_handler --> admin: 400 Bad Request 응답
        note right admin: 응답 메시지: 요청 경로 또는 파라미터 값이 유효하지 않습니다.
    else PathVariable 검증 실패 (타입 변환 실패)
        admin_member_controller -> global_exception_handler: TypeMismatchException 예외 발생
        global_exception_handler --> admin: 400 Bad Request 응답
        note right admin: 응답 메시지: 요청 파라미터의 타입이 올바르지 않습니다.
    else PathVariable 검증 성공
        admin_member_controller -> member_service: grantAdmin(memberId) 메소드 호출
        activate member_service

        member_service -> member_query_repository: findOneBy(searchOption) 메소드 호출
        note right member_service: 회원 ID, 삭제 플래그를 검색옵션으로 사용하여 데이터를 조회합니다.
        activate member_query_repository
        member_query_repository -> db: ID와 일치하고 삭제되지 않은 회원 데이터 조회
        db --> member_query_repository: 조회한 회원 데이터 반환
        member_query_repository --> member_service: Member 객체 반환
        deactivate member_query_repository
        alt 유효하지 않은 회원 데이터
            member_service -> global_exception_handler: MemberNotFoundException 예외 발생
            global_exception_handler --> admin: 404 Not Found 응답
            note right admin: 에러 메시지: 해당 회원이 존재하지 않습니다.
        else 유효한 회원 데이터
            member_service -> member_role_service: create(member, roleType) 메소드 호출
            activate member_role_service
            member_role_service -> member_role_query_repository: existsByMemberIdAndRoleType() 메소드 호출
            note right member_role_service: 회원 ID와 역할 타입과 일치하는 데이터 존재 여부를 조회합니다.
            activate member_role_query_repository
            member_role_query_repository -> db: 회원 ID와 관리자 역할 데이터 존재 여부 조회
            db --> member_role_query_repository: 조회한 결과 데이터 반환
            member_role_query_repository --> member_role_service: 역할 데이터 존재 여부 반환
            deactivate member_role_query_repository
            alt 역할이 존재할 경우
                member_role_service -> global_exception_handler: AlreadyGrantedException 예외 발생
                global_exception_handler --> admin: 400 Bad Request 응답
                note right admin: 에러 메시지: 해당 회원에게 이미 부여된 역할입니다.
            else 역할이 존재하지 않을 경우
                member_role_service -> member_role_query_repository: save(memberRole) 메소드 호출
                activate member_role_query_repository
                member_role_query_repository -> db: 회원에게 관리자 역할 데이터 저장
                deactivate member_role_query_repository
                deactivate member_role_service

                member_service -> member_document_repository: get(memberId) 메소드 호출
                activate member_document_repository
                member_document_repository -> es: 회원 ID와 일치하는 문서 데이터 검색
                es --> member_document_repository: 회원 ID와 일치하는 문서 데이터 반환
                member_document_repository --> member_service: MemberDocument 객체 반환
                deactivate member_document_repository

                member_service -> member_document_repository: save(MemberDocument) 메소드 호출
                activate member_document_repository
                member_document_repository -> es: 추가된 관리자 역할을 문서에 반영
                deactivate member_document_repository
                deactivate member_service

                admin_member_controller --> dispatcher_servlet: ResponseEntity<CommonResponse> 객체 반환
                deactivate admin_member_controller

                dispatcher_servlet --> admin: 200 OK 응답
                note right admin: 성공 메시지: 해당 회원에 관리자 권한을 부여했습니다.
                deactivate admin
            end
        end
    end
end

@enduml