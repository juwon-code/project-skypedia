@startuml
autonumber

title 회원 목록 검색 API 시퀀스 다이어그램

actor Admin as admin

box "Presentation Layer"
    participant "DispatcherServlet" as dispatcher_servlet
    participant "AdminMemberController" as admin_member_controller
end box

box "Service Layer" #Pink
    participant "MemberService" as member_service
    participant "PhotoMemberService" as photo_member_service
end box

box "Repository Layer" #LightGreen
    participant "MemberDocumentRepository" as member_document_repository
end box

box "Infrastructure Layer" #LightBlue
    participant "GlobalExceptionHandler" as global_exception_handler
    database "Database" as db
    database "ElasticSearch" as es
end box

group 회원 목록 검색
    admin -> dispatcher_servlet: "GET /api/v1/admin/member/search?[search params] 요청"
    activate admin

    dispatcher_servlet -> admin_member_controller: search(searchOption, keyword, sortType, page) 메소드 호출
    activate admin_member_controller

    alt RequestParam 검증 실패 (음수값 감지)
        admin_member_controller -> global_exception_handler: ConstraintViolationException 예외 발생
        global_exception_handler --> admin: 400 Bad Request 응답
        note right admin: 응답 메시지: 요청 경로 또는 파라미터 값이 유효하지 않습니다.
    else RequestParam 검증 실패 (타입 변환 실패)
        admin_member_controller -> global_exception_handler: TypeMismatchException 예외 발생
        global_exception_handler --> admin: 400 Bad Request 응답
        note right admin: 응답 메시지: 요청 파라미터의 타입이 올바르지 않습니다.
    else RequestParam 검증 성공
        admin_member_controller -> member_service: search(requestDto) 메소드 호출
        activate member_service

        member_service -> member_document_repository: findBy(keyword, option, sortType, pageable) 메소드 호출
        note right member_service: 태그, 키워드로 문서를 검색하고, 특정 페이지의 문서를 정렬하여 조회합니다.
        activate member_document_repository
        member_document_repository -> es: 조건과 일치하는 회원 데이터 조회
        es --> member_document_repository: 조회한 회원 데이터 반환
        member_document_repository --> member_service: SearchHits 객체 반환
        deactivate member_document_repository

        alt 검색 결과 없음
            member_service -> global_exception_handler: SearchNotFoundException 예외 발생
            global_exception_handler --> admin: 204 No Content 응답
            note right admin: 검색 결과가 존재하지 않습니다.
        else 검색 결과 있음
            member_service -> photo_member_service: getReadUrls(memberIds) 메소드 호출
            note right member_service: getReadUrls(memberIds)를 호출하여 ID와 일치하는 프로필 사진 URL 목록을 가져옵니다.
            activate photo_member_service
            photo_member_service -> db: 회원 ID와 일치하는 사진 데이터 목록 검색
            note right photo_member_service: 자세한 사항은 사진 목록 조회 API 시퀀스 다이어그램을 참고해주세요.
            db --> photo_member_service: List<Photo> 객체 반환
            photo_member_service --> member_service: 프로필 사진 URL 목록 반환
            deactivate photo_member_service

            member_service --> admin_member_controller: Pagination DTO 객체 반환
            note right admin_member_controller: 페이지 정보 및 회원 정보와 프로필 사진 URL 목록을 포함한 데이터를 반환합니다.
            deactivate member_service

            admin_member_controller --> dispatcher_servlet: ResponseEntity<CommonResponse> 객체 반환
            note right dispatcher_servlet: 성공 메시지와 데이터를 ResponseEntity로 감싸서 반환합니다.
            deactivate admin_member_controller

            dispatcher_servlet --> admin: 200 OK 응답
            note right admin: 성공 메시지: 데이터를 성공적으로 조회했습니다.
            deactivate admin
        end
    end
end

@enduml